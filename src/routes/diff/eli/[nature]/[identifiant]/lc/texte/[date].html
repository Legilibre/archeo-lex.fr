<svelte:head>
	<title>{ucfirst(identifiant)}</title>
</svelte:head>

<div id="texte" class="centre">

<h1>Version consolidée {#if date !== '2222-02-22'}au {ISO86012dateFR(date)}{:else}à une future date indéterminée{/if}</h1>

<h2 class="soustitre">La précédente version était la version consolidée {#if date !== '2222-02-22'}au {ISO86012dateFR(date_prev)}{:else}à une future date indéterminée{/if}.</h2>

<p>&lt; <a rel="prefetch" href="{base}/eli/{nature}">{ucfirst(nature)}s</a> &lt; <a rel="prefetch" href="{base}/eli/{nature}/{identifiant}">{ucfirst(identifiant)}</a> <span class="version"># <span title="Référence unique (commit Git)">{condensat.substring(0, 7)}</span></span></p>

{#each diffs as article}
{@html markdown2html(article[7])}
{/each}

</div>

<style>
:global(del) {
	background-color: #fdd;
}
:global(ins) {
	background-color: #74ed74;
}
h2.soustitre {
	font-size: 1em;
	font-weight: normal;
	line-height: 1;
	color: #777;
	text-decoration: none;
	margin-block-start: 0em;
	margin-left: 1em;
}
</style>

<script>

	import config from '../../../../../../../config';
	import markdown from '../../../../../../../lib/markdown';
	import l10n from '../../../../../../../lib/l10n';

	export default {
		async preload({ params }) {
			const { nature, identifiant, date } = params,
			      res = await this.fetch(`diff/eli/${nature}/${identifiant}/lc/texte/${date}.json`),
			      texte = res.status === 200 ? await res.json() : {}

			if( res.status !== 200 ) {
				this.error( res.status, 'Missing' )
				return
			}

			return {
				base: config.base,
				nature,
				identifiant,
				condensat: texte.condensat,
				date: texte.date,
				date_prev: texte.date_prev,
				texte: texte.texte,
				diffs: texte.diffs,
			}
		},

		helpers: {
			ISO86012dateFR(iso8601) {
				const r = /^([0-9]{4})-?([0-9]{2})-?([0-9]{2})$/.exec(iso8601);
				return r ? (r[3][0] == '0' ? r[3][1] : r[3]) + (r[3] == '01' ? 'er' : '') + ' ' + l10n.moisFR['fr'][r[2]] + ' ' + r[1] : '';
			},
			markdown2html(text) {
				return markdown.markdown2html(text);
			},
			ucfirst(s) {
				s = s.trim().replace(/_/g, ' ');
				return s.substring(0, 1).toUpperCase() + s.substring(1);
			}
		}
	};
</script>
